# 自动提取和分析工作流程

## 📋 完整流程

```
用户点击"立即提取"
    ↓
1. 创建后台任务 (TaskManager)
    ↓
2. 打开新标签页加载目标 URL
    ↓
3. 等待页面加载完成
    ↓
4. 注入 Content Script 提取页面内容
    - HTML 结构
    - CSS 样式
    - 元数据
    ↓
5. 保存快照到 IndexedDB
    ↓
6. 🤖 自动调用 AI 分析 (NEW!)
    - 加载 AI 配置（默认模型）
    - 构建分析 Prompt
    - 调用 AI API
    - 解析响应
    - 生成 Markdown 报告
    ↓
7. 📥 自动下载 Markdown (NEW!)
    - 文件名：{页面标题}_style.md
    - 保存到默认下载文件夹
    ↓
8. 任务完成 ✅
    - 关闭临时标签页
    - 更新任务状态
    - 通知用户
```

## 🎯 关键特性

### ✨ 自动化
- **一键完成**：点击按钮后全自动执行
- **无需等待**：后台任务异步处理
- **智能重试**：失败自动重试（可配置）

### 🤖 AI 分析
- **自动触发**：提取完成后立即分析
- **使用默认模型**：自动选择配置的默认 AI 模型
- **容错处理**：分析失败不影响快照保存

### 📥 自动下载
- **即时下载**：分析完成立即下载 Markdown
- **智能命名**：使用页面标题作为文件名
- **自动保存**：无需用户选择保存位置

## 📊 任务状态

| 状态 | 说明 | 进度 |
|------|------|------|
| `pending` | 等待执行 | 0% |
| `running` | 正在提取 | 20-80% |
| `analyzing` | AI 分析中 | 85-95% |
| `completed` | 已完成 | 100% |
| `failed` | 失败 | - |

## 🔧 配置要求

### 必需配置
1. **AI 模型**
   - 至少配置一个 AI 模型
   - 设置默认模型（`isDefault: true`）
   - 确保 API Key 有效

2. **生成选项**
   - 选择需要分析的内容
   - 设置报告语言

### 可选配置
- Temperature（默认 0.7）
- Max Tokens（默认 4000）
- 自定义 Prompt

## 📝 输出文件

### Markdown 报告结构
```markdown
# {页面标题} - 设计风格分析报告

> **分析时间**: 2025-11-23 23:14:00
> **页面 URL**: https://example.com
> **采集时间**: 2025-11-23 23:13:00
> **视口尺寸**: 1920 x 1080

---

## 📊 概览
[AI 生成的总结]

---

## 🎨 色彩方案
### 主色调
- #4facfe
- #00f2fe

### 辅助色
- #f093fb
- #4facfe

---

## ✍️ 字体系统
### 字体族
- Inter
- SF Pro Display

---

## 📐 布局分析
- **布局方式**: Flexbox + Grid
- **栅格系统**: 12列

---

## 🧩 组件风格
### Buttons
[组件分析]

### Cards
[组件分析]

---

## ♿ 可访问性评估
- **评分**: 85/100
### 问题
- 部分按钮缺少 aria-label
- 对比度不足

---

## 💡 改进建议
### 1. 提升对比度
[详细建议]

### 2. 添加无障碍标签
[详细建议]

---

*本报告由 Frontend Style Generator AI 自动生成*
*生成时间: 2025-11-23 23:14:00*
```

## 🚀 使用示例

### 基本使用
1. 打开扩展 Popup
2. 确认已配置 AI 模型
3. 点击"立即提取"按钮
4. 等待任务完成
5. Markdown 文件自动下载到下载文件夹

### 批量提取
1. 切换到"全部页面"模式
2. 点击"立即提取"
3. 扫描所有路由
4. 逐个提取并分析
5. 生成多个 Markdown 文件

## ⚠️ 注意事项

### AI 分析可能失败的情况
- API Key 无效或过期
- 网络连接问题
- API 配额不足
- 页面内容过大超出 Token 限制

### 失败处理
- 快照仍会保存到 IndexedDB
- 可以在历史记录中手动重新分析
- 任务状态会显示错误信息

## 🔍 调试

### 查看日志
```javascript
// 打开 Service Worker 控制台
chrome://extensions/ → 详细信息 → Service Worker → 检查视图

// 查看任务状态
[TaskManager] 任务创建: task_xxx
[TaskManager] 正在提取: https://example.com
[TaskManager] AI 分析中...
[TaskManager] Markdown 已下载: Example_style.md
[TaskManager] 任务完成: task_xxx
```

### 常见问题
1. **下载失败**
   - 检查 `downloads` 权限
   - 查看浏览器下载设置

2. **AI 分析超时**
   - 增加 Max Tokens
   - 简化分析选项

3. **文件名乱码**
   - 页面标题包含特殊字符
   - 自动替换为下划线
