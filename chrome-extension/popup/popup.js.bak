/**
 * Popup 控制器 - 苹果风格
 */
class PopupController {
  constructor() {
    this.currentTab = null;
    this.currentMode = 'current'; // 'current' or 'all'
    this.tasks = [];
    this.domainCollapse = {};
    this.selectedTasks = new Set(); // 选中的任务ID
    this.queuePaused = false;
    this.init();
  }
  
  async init() {
    try {
      // 获取当前标签页
      const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
      this.currentTab = tab;
      
      // 显示页面信息
      this.displayPageInfo(tab);
      
      // 绑定事件（先绑定事件，确保 DOM 元素存在）
      this.bindEvents();
      
      // 加载配置和模型选项
      await this.loadConfig();
      
      // 加载任务列表
      await this.loadTasks();
      
      // 监听后台任务更新
      this.listenTaskUpdates();
    } catch (error) {
      console.error('初始化失败:', error);
    }
  }
  
  /**
   * 显示页面信息
   */
  displayPageInfo(tab) {
    const pageTitle = document.getElementById('pageTitle');
    const pageUrl = document.getElementById('pageUrl');
    
    if (pageTitle) {
      pageTitle.textContent = tab.title || '未命名页面';
    }
    
    if (pageUrl) {
      try {
        const url = new URL(tab.url);
        pageUrl.textContent = url.hostname;
      } catch {
        pageUrl.textContent = tab.url;
      }
    }
  }
  
  /**
   * 加载配置
   */
  async loadConfig() {
    const result = await chrome.storage.local.get(['aiModels']);
    const aiModels = result.aiModels || [];
    
    // 获取默认模型
    const defaultModel = aiModels.find(m => m.isDefault) || aiModels[0] || null;
    
    this.displayModelSelector(defaultModel, aiModels);
  }
  
  /**
   * 显示模型选择器
   */
  displayModelSelector(defaultModel, allModels) {
    const container = document.getElementById('modelSelectorContainer');
    
    if (!container) {
      return;
    }
    
    if (!defaultModel || !defaultModel.apiKey || !defaultModel.modelId) {
      // 显示空状态
      container.innerHTML = `
        <div class="model-empty">
          <div class="model-empty-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
              <path d="M12 1V3M12 21V23M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M1 12H3M21 12H23M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="model-empty-text">
            还没有配置 AI 模型<br>
            请先在设置中添加模型配置
          </div>
          <button class="model-empty-btn" id="goToSettingsBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
              <path d="M12 1V3M12 21V23M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M1 12H3M21 12H23M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>前往设置</span>
          </button>
        </div>
      `;
      
      // 绑定前往设置按钮
      const goToSettingsBtn = document.getElementById('goToSettingsBtn');
      if (goToSettingsBtn) {
        goToSettingsBtn.addEventListener('click', () => {
          chrome.runtime.openOptionsPage();
        });
      }
    } else {
      // 显示模型卡片
      const modelInitial = defaultModel.name.substring(0, 2).toUpperCase();
      const provider = defaultModel.baseUrl.includes('openai') ? 'OpenAI' : 
                      defaultModel.baseUrl.includes('anthropic') ? 'Anthropic' : '自定义';
      
      container.innerHTML = `
        <div class="model-card">
          <div class="model-icon">${modelInitial}</div>
          <div class="model-info">
            <div class="model-name">${defaultModel.name}</div>
            <div class="model-provider">${provider}</div>
          </div>
          <svg class="model-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      `;
      
      // 点击卡片打开设置
      container.querySelector('.model-card').addEventListener('click', () => {
        chrome.runtime.openOptionsPage();
      });
    }
  }
  
  /**
   * 绑定事件
   */
  bindEvents() {
    // URL 输入框事件
    const urlInput = document.getElementById('customUrlInput');
    const clearBtn = document.getElementById('clearUrlBtn');
    
    if (urlInput && clearBtn) {
      urlInput.addEventListener('input', () => {
        clearBtn.style.display = urlInput.value ? 'flex' : 'none';
      });
      
      clearBtn.addEventListener('click', () => {
        urlInput.value = '';
        clearBtn.style.display = 'none';
        urlInput.focus();
      });
    }
    
    // 设置按钮
    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) {
      settingsBtn.addEventListener('click', () => {
        chrome.runtime.openOptionsPage();
      });
    }
    
    // 任务队列按钮
    const tasksBtn = document.getElementById('tasksBtn');
    if (tasksBtn) {
      tasksBtn.addEventListener('click', () => {
        this.openTasksModal();
      });
    } else {
      console.warn('未找到任务按钮元素 (tasksBtn)');
    }
    
    // 关闭弹窗
    const closeModalBtn = document.getElementById('closeModalBtn');
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', () => {
        this.closeTasksModal();
      });
    }
    
    // 点击弹窗背景关闭
    const modalOverlay = document.querySelector('.modal-overlay');
    if (modalOverlay) {
      modalOverlay.addEventListener('click', () => {
        this.closeTasksModal();
      });
    }
    
    // 模式切换
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.switchMode(e.currentTarget.dataset.mode);
      });
    });
    
    // 立即提取按钮
    const extractBtn = document.getElementById('extractBtn');
    if (extractBtn) {
      extractBtn.addEventListener('click', () => {
        this.extract();
      });
    }
    
    // 清除已完成任务
    const clearCompletedBtn = document.getElementById('clearCompletedBtn');
    if (clearCompletedBtn) {
      clearCompletedBtn.addEventListener('click', () => {
        this.clearSelected();
      });
    }
    
    // 全选/取消全选
    const selectAllBtn = document.getElementById('selectAllBtn');
    if (selectAllBtn) {
      selectAllBtn.addEventListener('click', () => {
        this.toggleSelectAll();
      });
    }
    
    // 暂停队列
    const pauseQueueBtn = document.getElementById('pauseQueueBtn');
    if (pauseQueueBtn) {
      pauseQueueBtn.addEventListener('click', () => {
        this.pauseQueue();
      });
    }
    
    // 继续队列
    const resumeQueueBtn = document.getElementById('resumeQueueBtn');
    if (resumeQueueBtn) {
      resumeQueueBtn.addEventListener('click', () => {
        this.resumeQueue();
      });
    }
  }
  
  /**
   * 切换模式
   */
  switchMode(mode) {
    this.currentMode = mode;
    
    // 更新按钮状态
    document.querySelectorAll('.mode-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.mode === mode);
    });
  }
  
  /**
   * 打开任务队列弹窗
   */
  openTasksModal() {
    const modal = document.getElementById('tasksModal');
    if (modal) {
      modal.style.display = 'flex';
      this.loadTasks();
    }
  }
  
  /**
   * 关闭任务队列弹窗
   */
  closeTasksModal() {
    const modal = document.getElementById('tasksModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  
  /**
   * 提取
   */
  async extract() {
    // 从存储中获取配置，如果没有则使用默认值（全选）
    const result = await chrome.storage.local.get(['extractOptions']);
    const options = result.extractOptions || {
      inlineCSS: true,
      collectImages: true,
      collectFonts: true
    };
    
    // 获取自定义 URL（如果有）
    const customUrl = document.getElementById('customUrlInput').value.trim();
    
    if (this.currentMode === 'current') {
      await this.extractCurrent(options, customUrl);
    } else {
      await this.extractAll(options, customUrl);
    }
  }
  
  /**
   * 提取当前页面
   */
  async extractCurrent(options, customUrl) {
    try {
      // 使用自定义 URL 或当前标签页 URL
      const targetUrl = customUrl || this.currentTab?.url;
      
      if (!targetUrl) {
        this.showNotification('error', '无法获取目标 URL');
        return;
      }
      
      // 验证 URL
      if (customUrl) {
        try {
          new URL(customUrl);
        } catch (e) {
          this.showNotification('error', '请输入有效的 URL');
          return;
        }
      }
      
      // 添加到后台任务
      const response = await chrome.runtime.sendMessage({
        type: 'ADD_TASK',
        url: targetUrl,
        options
      });
      
      if (response.success) {
        // 打开任务队列弹窗
        this.openTasksModal();
        this.showNotification('success', '任务已添加到队列，可以关闭此窗口');
      }
    } catch (error) {
      this.showNotification('error', '添加任务失败：' + error.message);
    }
  }
  
  /**
   * 提取所有页面
   */
  async extractAll(options, customUrl) {
    try {
      // 如果有自定义 URL，只提取该 URL，忽略扫描路由
      if (customUrl) {
        try {
          new URL(customUrl);
        } catch (e) {
          this.showNotification('error', '请输入有效的 URL');
          return;
        }
        
        const response = await chrome.runtime.sendMessage({
          type: 'ADD_TASK',
          url: customUrl,
          options
        });
        
        if (response.success) {
          this.openTasksModal();
          this.showNotification('success', '任务已添加到队列');
        }
        return;
      }
      
      // 先扫描路由
      if (!this.currentTab?.id || !this.currentTab?.url) {
        this.showNotification('error', '无法获取当前标签页信息');
        return;
      }
      
      const response = await chrome.tabs.sendMessage(this.currentTab.id, {
        action: 'scanRoutes'
      });
      
      if (response && response.success && response.routes.length > 0) {
        const baseUrl = new URL(this.currentTab.url);
        const urls = response.routes.map(route => new URL(route, baseUrl).toString());
        
        // 批量添加任务
        const batchResponse = await chrome.runtime.sendMessage({
          type: 'ADD_BATCH_TASKS',
          urls,
          options
        });
        
        if (batchResponse.success) {
          this.openTasksModal();
          let message = `已添加 ${urls.length} 个任务到队列`;
          if (response.totalFound && response.totalFound > urls.length) {
            message += `（共发现 ${response.totalFound} 个页面，已按深度排序并限制为前 ${urls.length} 个）`;
          }
          this.showNotification('success', message);
        }
      } else {
        this.showNotification('error', '未找到可提取的页面');
      }
    } catch (error) {
      this.showNotification('error', '扫描失败：' + error.message);
    }
  }
  
  /**
   * 加载任务列表
   */
  async loadTasks() {
    try {
      const response = await chrome.runtime.sendMessage({
        type: 'GET_TASKS'
      });
      
      if (response.success) {
        this.tasks = response.tasks;
        this.displayTasks(response.tasks);
        this.updateStats();
        await this.updateQueueState();
        this.updateClearButton();
        this.updateSelectAllButton();
      }
    } catch (error) {
      console.error('加载任务失败:', error);
    }
  }
  
  /**
   * 显示任务列表
   */
  displayTasks(tasks) {
    const list = document.getElementById('tasksList');
    
    if (tasks.length === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/>
            <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <p>暂无任务</p>
        </div>
      `;
      return;
    }
    
    list.innerHTML = '';
    const groups = {};
    tasks.forEach(t => {
      const domain = (() => { try { return new URL(t.url).hostname; } catch { return '未知域名'; } })();
      if (!groups[domain]) groups[domain] = [];
      groups[domain].push(t);
    });

    Object.entries(groups).forEach(([domain, domainTasks]) => {
      const group = document.createElement('div');
      const header = document.createElement('div');
      const arrow = document.createElement('span');
      const count = document.createElement('span');
      const body = document.createElement('div');

      group.style.marginBottom = '8px';
      header.style.cssText = 'padding:10px 8px; border-radius:8px; background:#f8fafc; display:flex; align-items:center; gap:8px; cursor:pointer;';
      arrow.textContent = '▶';
      arrow.style.cssText = 'display:inline-block; transition:transform .2s; color: var(--text-secondary);';
      header.appendChild(arrow);
      const title = document.createElement('span');
      title.textContent = domain;
      title.style.cssText = 'font-weight:600; font-size:12px; color: var(--text-secondary);';
      header.appendChild(title);
      count.textContent = domainTasks.length;
      count.style.cssText = 'margin-left:auto; font-size:12px; color: var(--text-secondary);';
      header.appendChild(count);

      const collapsed = this.domainCollapse[domain] !== false;
      if (!collapsed) arrow.style.transform = 'rotate(90deg)';

      body.style.cssText = 'margin-top:8px;';
      body.style.display = collapsed ? 'none' : 'block';
      
      // 添加新增任务输入框（在任务列表之前）
      const addTaskSection = this.createAddTaskInput(domain);
      body.appendChild(addTaskSection);
      
      // 添加任务列表
      domainTasks.forEach(task => body.appendChild(this.createTaskItem(task)));

      header.addEventListener('click', () => {
        const isCollapsed = body.style.display === 'none';
        body.style.display = isCollapsed ? 'block' : 'none';
        arrow.style.transform = isCollapsed ? 'rotate(90deg)' : 'rotate(0deg)';
        this.domainCollapse[domain] = isCollapsed ? false : true;
      });

      group.appendChild(header);
      group.appendChild(body);
      list.appendChild(group);
    });
  }
  
  /**
   * 创建新增任务输入框
   */
  createAddTaskInput(domain) {
    const section = document.createElement('div');
    section.className = 'add-task-section-inline';
    section.style.cssText = 'margin-bottom: 12px;';
    
    const wrapper = document.createElement('div');
    wrapper.className = 'add-task-input-wrapper';
    wrapper.style.cssText = `
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #ffffff;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      transition: all 0.2s;
    `;
    
    // 图标
    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    icon.setAttribute('width', '16');
    icon.setAttribute('height', '16');
    icon.setAttribute('viewBox', '0 0 24 24');
    icon.setAttribute('fill', 'none');
    icon.style.cssText = 'color: var(--text-secondary); flex-shrink: 0;';
    icon.innerHTML = `
      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    `;
    
    // 输入框
    const input = document.createElement('input');
    input.type = 'url';
    input.className = 'add-task-input';
    input.placeholder = '输入 URL 添加新任务...';
    input.dataset.domain = domain;
    input.style.cssText = `
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      font-size: 13px;
      color: var(--text-primary);
      font-family: inherit;
    `;
    
    // 添加按钮
    const button = document.createElement('button');
    button.className = 'add-task-btn';
    button.dataset.domain = domain;
    button.style.cssText = `
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: var(--primary-gradient);
      border: none;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    `;
    
    const btnIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    btnIcon.setAttribute('width', '16');
    btnIcon.setAttribute('height', '16');
    btnIcon.setAttribute('viewBox', '0 0 24 24');
    btnIcon.setAttribute('fill', 'none');
    btnIcon.innerHTML = `<path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>`;
    button.appendChild(btnIcon);
    
    // 事件监听
    wrapper.addEventListener('focusin', () => {
      wrapper.style.borderColor = 'var(--accent-color)';
      wrapper.style.boxShadow = '0 0 0 3px rgba(107, 157, 214, 0.1)';
    });
    
    wrapper.addEventListener('focusout', () => {
      wrapper.style.borderColor = 'var(--border-color)';
      wrapper.style.boxShadow = 'none';
    });
    
    button.addEventListener('mouseenter', () => {
      button.style.transform = 'translateY(-1px)';
      button.style.boxShadow = '0 4px 12px rgba(107, 157, 214, 0.3)';
    });
    
    button.addEventListener('mouseleave', () => {
      button.style.transform = 'translateY(0)';
      button.style.boxShadow = 'none';
    });
    
    button.addEventListener('click', (e) => {
      e.stopPropagation();
      this.addNewTask(domain, input);
    });
    
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.stopPropagation();
        this.addNewTask(domain, input);
      }
    });
    
    wrapper.appendChild(icon);
    wrapper.appendChild(input);
    wrapper.appendChild(button);
    section.appendChild(wrapper);
    
    return section;
  }
  
  /**
   * 创建任务项
   */
  createTaskItem(task) {
    const item = document.createElement('div');
    item.className = `task-item ${task.status}`;
    
    const statusIcons = {
      pending: '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>',
      running: '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2"/>',
      analyzing: '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M12 8a4 4 0 1 0 4 4" stroke="currentColor" stroke-width="2"/>',
      completed: '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2"/>',
      failed: '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M15 9l-6 6M9 9l6 6" stroke="currentColor" stroke-width="2"/>'
    };
    
    const statusTexts = {
      pending: '等待中',
      running: '进行中',
      analyzing: '分析中',
      completed: '已完成',
      failed: '失败'
    };
    
    const isSelected = this.selectedTasks.has(task.id);
    
    item.innerHTML = `
      <div style="display: flex; align-items: center; gap: 14px;">
        <input type="checkbox" class="task-checkbox" data-task-id="${task.id}" ${isSelected ? 'checked' : ''}>
        <svg class="task-status-icon" width="22" height="22" viewBox="0 0 24 24" fill="none">
          ${statusIcons[task.status]}
        </svg>
        <div style="flex: 1; min-width: 0;">
          <div style="font-size: 14px; font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${task.title}
          </div>
          <div style="font-size: 12px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${task.url}
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:8px; font-size: 12px; font-weight: 600; color: var(--text-secondary); flex-shrink: 0;">
          <span style="min-width: 50px; text-align: right;">${statusTexts[task.status]}</span>
          <span style="min-width: 35px; text-align: right;">${task.progress}%</span>
        </div>
      </div>
      ${task.progress > 0 && task.progress < 100 ? `
        <div style="margin-top: 12px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
          <div style="height: 100%; background: var(--blue-gradient); width: ${task.progress}%; transition: width 0.3s;"></div>
        </div>
      ` : ''}
    `;
    
    // 绑定复选框事件
    const checkbox = item.querySelector('.task-checkbox');
    if (checkbox) {
      checkbox.addEventListener('change', (e) => {
        e.stopPropagation();
        if (e.target.checked) {
          this.selectedTasks.add(task.id);
        } else {
          this.selectedTasks.delete(task.id);
        }
        this.updateClearButton();
        this.updateSelectAllButton();
      });
    }
    
    return item;
  }
  
  /**
   * 更新统计信息
   */
  async updateStats() {
    try {
      const response = await chrome.runtime.sendMessage({
        type: 'GET_STATS'
      });
      
      if (response.success) {
        const stats = response.stats;
        
        const totalTasks = document.getElementById('totalTasks');
        const runningTasks = document.getElementById('runningTasks');
        const completedTasks = document.getElementById('completedTasks');
        const failedTasks = document.getElementById('failedTasks');
        
        if (totalTasks) totalTasks.textContent = stats.total;
        if (runningTasks) runningTasks.textContent = stats.running;
        if (completedTasks) completedTasks.textContent = stats.completed;
        if (failedTasks) failedTasks.textContent = stats.failed;
        
        // 更新任务徽章
        const badge = document.getElementById('taskBadge');
        if (badge) {
          if (stats.running > 0) {
            badge.textContent = stats.running;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
        
        // 显示/隐藏统计
        const summary = document.getElementById('tasksSummary');
        if (summary) {
          summary.style.display = stats.total > 0 ? 'grid' : 'none';
        }
      }
    } catch (error) {
      console.error('更新统计失败:', error);
    }
  }
  
  /**
   * 清除已完成任务或选中的任务
   */
  async clearCompleted() {
    // 如果有选中的任务，清除选中的
    if (this.selectedTasks.size > 0) {
      await this.clearSelected();
      return;
    }
    
    // 否则清除已完成的任务
    try {
      const response = await chrome.runtime.sendMessage({
        type: 'CLEAR_COMPLETED'
      });
      
      if (response.success) {
        await this.loadTasks();
        this.showNotification('success', '已清除完成的任务');
      }
    } catch (error) {
      this.showNotification('error', '清除失败');
    }
  }
  
  /**
   * 清除选中的任务
   */
  async clearSelected() {
    if (this.selectedTasks.size === 0) {
      this.showNotification('error', '请先选择要清除的任务');
      return;
    }
    
    const count = this.selectedTasks.size;
    if (!confirm(`确定要删除 ${count} 个选中的任务吗？此操作不可恢复。`)) {
      return;
    }
    
    try {
      // 批量删除选中的任务
      const deletePromises = Array.from(this.selectedTasks).map(taskId =>
        chrome.runtime.sendMessage({
          type: 'DELETE_TASK',
          taskId
        })
      );
      
      await Promise.all(deletePromises);
      
      this.selectedTasks.clear();
      await this.loadTasks();
      this.showNotification('success', `已删除 ${count} 个任务`);
    } catch (error) {
      this.showNotification('error', '删除失败：' + error.message);
    }
  }
  
  /**
   * 全选/取消全选
   */
  toggleSelectAll() {
    if (this.selectedTasks.size === this.tasks.length) {
      // 全部取消选中
      this.selectedTasks.clear();
    } else {
      // 全选
      this.tasks.forEach(task => this.selectedTasks.add(task.id));
    }
    this.displayTasks(this.tasks);
    this.updateClearButton();
    this.updateSelectAllButton();
  }
  
  /**
   * 更新清除按钮文本
   */
  updateClearButton() {
    const clearBtn = document.getElementById('clearCompletedBtn');
    if (clearBtn) {
      if (this.selectedTasks.size > 0) {
        clearBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M19 6V20C19 21.1 18.1 22 17 22H7C5.9 22 5 21.1 5 20V6" stroke="currentColor" stroke-width="2"/>
            <path d="M8 6V4C8 2.9 8.9 2 10 2H14C15.1 2 16 2.9 16 4V6" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span>清除选中 (${this.selectedTasks.size})</span>
        `;
      } else {
        clearBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M19 6V20C19 21.1 18.1 22 17 22H7C5.9 22 5 21.1 5 20V6" stroke="currentColor" stroke-width="2"/>
            <path d="M8 6V4C8 2.9 8.9 2 10 2H14C15.1 2 16 2.9 16 4V6" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span>清除已完成</span>
        `;
      }
    }
  }
  
  /**
   * 更新全选按钮文本
   */
  updateSelectAllButton() {
    const selectAllBtn = document.getElementById('selectAllBtn');
    if (selectAllBtn) {
      const allSelected = this.tasks.length > 0 && this.selectedTasks.size === this.tasks.length;
      selectAllBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
          ${allSelected ? '<path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' : ''}
        </svg>
        <span>${allSelected ? '取消全选' : '全选'}</span>
      `;
    }
  }
  
  /**
   * 更新队列状态
   */
  async updateQueueState() {
    try {
      const response = await chrome.runtime.sendMessage({
        type: 'GET_QUEUE_STATE'
      });
      
      if (response.success) {
        this.queuePaused = response.state.paused;
        
        const pauseBtn = document.getElementById('pauseQueueBtn');
        const resumeBtn = document.getElementById('resumeQueueBtn');
        
        if (pauseBtn && resumeBtn) {
          if (this.queuePaused) {
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'flex';
          } else {
            pauseBtn.style.display = 'flex';
            resumeBtn.style.display = 'none';
          }
        }
      }
    } catch (error) {
      console.error('获取队列状态失败:', error);
    }
  }
  
  /**
   * 暂停队列
   */
  async pauseQueue() {
    try {
      const response = await chrome.runtime.sendMessage({
        type: 'PAUSE_QUEUE'
      });
      
      if (response.success) {
        await this.updateQueueState();
        this.showNotification('success', '队列已暂停');
      }
    } catch (error) {
      this.showNotification('error', '暂停失败');
    }
  }
  
  /**
   * 继续队列
   */
  async resumeQueue() {
    try {
      const response = await chrome.runtime.sendMessage({
        type: 'RESUME_QUEUE'
      });
      
      if (response.success) {
        await this.updateQueueState();
        this.showNotification('success', '队列已继续');
      }
    } catch (error) {
      this.showNotification('error', '继续失败');
    }
  }
  
  /**
   * 新增任务
   */
  async addNewTask(domain, inputElement) {
    let urlValue = inputElement.value.trim();
    
    if (!urlValue) {
      this.showNotification('error', '请输入 URL');
      return;
    }
    
    // 如果输入的不是完整 URL，尝试补全域名
    let fullUrl = urlValue;
    if (!urlValue.startsWith('http://') && !urlValue.startsWith('https://')) {
      // 如果只是路径，补全域名和协议
      if (urlValue.startsWith('/')) {
        fullUrl = `https://${domain}${urlValue}`;
      } else {
        // 尝试作为完整 URL
        fullUrl = `https://${urlValue}`;
      }
    }
    
    // 验证 URL
    try {
      const parsedUrl = new URL(fullUrl);
      // 检查域名是否匹配（如果输入的是完整URL，允许不同域名）
      if (urlValue.startsWith('/') && parsedUrl.hostname !== domain) {
        parsedUrl.hostname = domain;
        fullUrl = parsedUrl.toString();
      }
    } catch (e) {
      this.showNotification('error', '请输入有效的 URL');
      return;
    }
    
    try {
      // 获取当前提取选项
      const result = await chrome.storage.local.get(['extractOptions']);
      const options = result.extractOptions || {
        inlineCSS: true,
        collectImages: true,
        collectFonts: true
      };
      
      // 添加任务到队列
      const response = await chrome.runtime.sendMessage({
        type: 'ADD_TASK',
        url: fullUrl,
        options
      });
      
      if (response.success) {
        // 清空输入框
        inputElement.value = '';
        
        // 刷新任务列表
        await this.loadTasks();
        
        // 显示成功提示
        const message = this.queuePaused 
          ? '任务已添加到队列（队列已暂停）' 
          : '任务已添加到队列';
        this.showNotification('success', message);
      } else {
        this.showNotification('error', response.error || '添加任务失败');
      }
    } catch (error) {
      this.showNotification('error', '添加任务失败：' + error.message);
    }
  }
  
  /**
   * 编辑任务
   */
  async editTask(task) {
    const newUrl = prompt('请输入新的 URL：', task.url);
    
    if (newUrl && newUrl !== task.url) {
      try {
        const response = await chrome.runtime.sendMessage({
          type: 'EDIT_TASK_URL',
          taskId: task.id,
          newUrl
        });
        
        if (response.success) {
          await this.loadTasks();
          this.showNotification('success', '任务已更新');
        } else {
          this.showNotification('error', response.error || '编辑失败');
        }
      } catch (error) {
        this.showNotification('error', '编辑失败：' + error.message);
      }
    }
  }
  
  /**
   * 监听任务更新
   */
  listenTaskUpdates() {
    chrome.runtime.onMessage.addListener((message) => {
      if (message.type === 'TASKS_UPDATED') {
        this.loadTasks();
      }
    });
  }
  
  /**
   * 显示通知
   */
  showNotification(type, message) {
    // 简单的 alert，可以后续改为更优雅的通知
    const icons = {
      success: '✓',
      error: '✗'
    };
    alert(`${icons[type]} ${message}`);
  }
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
  new PopupController();
});
